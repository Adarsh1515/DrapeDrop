<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Addresses - DrapeDrop</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .profile-container {
            background-color: #f1f3f6;
            min-height: 100vh;
            padding: 20px 0;
        }

        .sidebar {
            background: #fff;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            height: fit-content;
        }

        .sidebar-user {
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            background: #fff;
            margin-bottom: 15px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .sidebar-user .avatar {
            width: 50px;
            height: 50px;
            background: #ffe11b;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sidebar-user .avatar i {
            font-size: 24px;
            color: #fff;
        }

        .main-content-area {
            background: #fff;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 24px;
            min-height: 400px;
        }

        .address-header {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 24px;
        }

        .add-address-btn {
            border: 1px solid #e0e0e0;
            background: #fff;
            color: #2874f0;
            font-weight: 600;
            padding: 16px;
            width: 100%;
            text-align: left;
            cursor: pointer;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .address-card {
            border: 1px solid #e0e0e0;
            padding: 20px;
            margin-bottom: 15px;
            position: relative;
        }

        .address-card-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .address-tag {
            background: #f0f0f0;
            color: #878787;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 2px;
            text-transform: uppercase;
            font-weight: 600;
            margin-left: 10px;
        }

        .address-actions-menu {
            position: absolute;
            right: 20px;
            top: 20px;
            border: 1px solid #e0e0e0;
            background: #fff;
            z-index: 10;
            display: none;
            flex-direction: column;
        }

        .address-actions-menu button {
            background: none;
            border: none;
            padding: 10px 20px;
            text-align: left;
            cursor: pointer;
            width: 100%;
        }

        .address-actions-menu button:hover {
            background: #f9f9f9;
        }

        /* Form Styles */
        .address-form {
            display: none;
            /* Hidden by default */
        }

        .form-header {
            font-size: 1rem;
            font-weight: 600;
            color: #2874f0;
            margin-bottom: 20px;
        }

        .location-btn {
            background: #2874f0;
            color: #fff;
            border: none;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 20px;
            border-radius: 2px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group-addr input,
        .form-group-addr select,
        .form-group-addr textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 2px;
            font-size: 0.95rem;
        }

        .form-group-addr textarea {
            resize: none;
            height: 80px;
        }

        .radio-group-addr {
            display: flex;
            gap: 20px;
            margin: 15px 0;
            align-items: center;
        }

        .radio-label {
            font-size: 0.85rem;
            color: #878787;
            margin-right: 10px;
        }

        .btn-row {
            margin-top: 30px;
            display: flex;
            gap: 20px;
        }

        .btn-save-addr {
            background: #2874f0;
            color: #fff;
            border: none;
            padding: 12px 60px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 2px;
        }

        .btn-cancel-addr {
            background: transparent;
            color: #2874f0;
            border: none;
            padding: 12px 20px;
            font-weight: 600;
            cursor: pointer;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            display: none;
        }

        .empty-state img {
            max-width: 200px;
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    <div class="profile-container">
        <div class="sidebar-layout">
            <!-- Sidebar (Reused) -->
            <div class="sidebar">
                <div class="sidebar-user">
                    <div class="avatar"><img src="https://ui-avatars.com/api/?name=User&background=ffe11b&color=fff"
                            style="border-radius:50%; width:100%; height:100%;"></div>
                    <div class="sidebar-user-info">
                        <div style="font-size: 0.8rem; color: #333;">Hello,</div>
                        <h3 id="sidebarUserName" style="margin:0; font-size: 1rem;">User</h3>
                    </div>
                </div>

                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item">
                        <a href="my_orders.html" class="sidebar-nav-link">
                            <i class="fas fa-box" style="width: 20px; color: #2874f0;"></i> <span>MY ORDERS</span>
                            <i class="fas fa-chevron-right"
                                style="font-size: 12px; margin-left: auto; color: #ccc;"></i>
                        </a>
                    </li>

                    <div class="sidebar-group-title"><i class="fas fa-user" style="width: 20px; color: #2874f0;"></i>
                        ACCOUNT SETTINGS</div>
                    <li class="sidebar-nav-item">
                        <a href="edit_profile.html" class="sidebar-nav-link">
                            <span>Profile Information</span>
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a href="#" class="sidebar-nav-link active"
                            style="background: #f0f5ff; color: #2874f0; font-weight: 600;">
                            <span>Manage Addresses</span>
                        </a>
                    </li>

                    <div class="sidebar-group-title"><i class="fas fa-wallet" style="width: 20px; color: #2874f0;"></i>
                        PAYMENTS</div>
                    <li class="sidebar-nav-item">
                        <a href="#" class="sidebar-nav-link">
                            <span>Saved UPI</span>
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a href="card.html" class="sidebar-nav-link">
                            <span>Saved Cards</span>
                        </a>
                    </li>

                    <div class="sidebar-group-title"><i class="fas fa-folder" style="width: 20px; color: #2874f0;"></i>
                        MY STUFF</div>
                    <li class="sidebar-nav-item">
                        <a href="#" class="sidebar-nav-link">
                            <span>My Reviews & Ratings</span>
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a href="#" class="sidebar-nav-link">
                            <span>All Notifications</span>
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a href="wishlist.html" class="sidebar-nav-link">
                            <span>My Wishlist</span>
                        </a>
                    </li>

                    <li class="sidebar-nav-item item-logout">
                        <a href="#" id="logoutBtn" class="sidebar-nav-link">
                            <i class="fas fa-power-off" style="width: 20px; color: #2874f0;"></i> <span>Logout</span>
                        </a>
                    </li>
                </ul>
            </div>

            <!-- Main Content -->
            <div class="main-content-areaWrapper" style="flex: 1;">
                <div class="main-content-area" id="viewMode">
                    <h2 class="address-header">Manage Addresses</h2>

                    <button class="add-address-btn" id="addNewAddrBtn">
                        <i class="fas fa-plus"></i> ADD A NEW ADDRESS
                    </button>

                    <div id="addressList">
                        <!-- Addresses will be injected here -->
                    </div>

                    <div class="empty-state" id="emptyState">
                        <img src="https://rukminim1.flixcart.com/www/800/800/promos/16/05/2019/d438a32e-765a-4d8b-b4a6-520b560971e8.png?q=90"
                            alt="No Addresses">
                        <h3>No Addresses found in your account!</h3>
                        <p style="color:#878787; margin-bottom:20px;">Add a delivery address.</p>
                        <button class="btn-save-addr" onclick="document.getElementById('addNewAddrBtn').click()"
                            style="width:auto;">ADD ADDRESSES</button>
                    </div>
                </div>

                <!-- Form (Initially Hidden) -->
                <div class="main-content-area address-form" id="formMode">
                    <div class="form-header">ADD A NEW ADDRESS</div>

                    <button class="location-btn" id="useLocationBtn">
                        <i class="fas fa-crosshairs"></i> Use my current location
                    </button>

                    <form id="addrForm">
                        <div class="form-grid">
                            <div class="form-group-addr">
                                <input type="text" id="name" placeholder="Name" required>
                            </div>
                            <div class="form-group-addr">
                                <input type="tel" id="mobile" placeholder="10-digit mobile number" required>
                            </div>
                        </div>
                        <div class="form-grid">
                            <div class="form-group-addr">
                                <input type="text" id="pincode" placeholder="Pincode" required>
                            </div>
                            <div class="form-group-addr">
                                <input type="text" id="locality" placeholder="Locality" required>
                            </div>
                        </div>
                        <div class="form-group-addr" style="margin-bottom:15px;">
                            <textarea id="addressArea" placeholder="Address (Area and Street)" required></textarea>
                        </div>
                        <div class="form-grid">
                            <div class="form-group-addr">
                                <input type="text" id="city" placeholder="City/District/Town" required>
                            </div>
                            <div class="form-group-addr">
                                <select id="state" required style="background:#fff;">
                                    <option value="" disabled selected>--Select State--</option>
                                    <option value="Madhya Pradesh">Madhya Pradesh</option>
                                    <option value="Maharashtra">Maharashtra</option>
                                    <option value="Delhi">Delhi</option>
                                    <option value="Karnataka">Karnataka</option>
                                    <!-- Add more as needed -->
                                </select>
                            </div>
                        </div>
                        <div class="form-grid">
                            <div class="form-group-addr">
                                <input type="text" id="landmark" placeholder="Landmark (Optional)">
                            </div>
                            <div class="form-group-addr">
                                <input type="tel" id="altPhone" placeholder="Alternate Phone (Optional)">
                            </div>
                        </div>

                        <div class="radio-group-addr">
                            <span class="radio-label">Address Type</span>
                            <label style="display:flex; align-items:center; gap:5px; cursor:pointer;">
                                <input type="radio" name="addrType" value="Home" checked> Home
                            </label>
                            <label style="display:flex; align-items:center; gap:5px; cursor:pointer;">
                                <input type="radio" name="addrType" value="Work"> Work
                            </label>
                        </div>

                        <div class="btn-row">
                            <button type="submit" class="btn-save-addr">SAVE</button>
                            <button type="button" class="btn-cancel-addr" id="cancelAddrBtn">CANCEL</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        const viewMode = document.getElementById('viewMode');
        const formMode = document.getElementById('formMode');
        const emptyState = document.getElementById('emptyState');
        const addressList = document.getElementById('addressList');
        const formHeader = document.querySelector('.form-header');

        let addresses = JSON.parse(localStorage.getItem('drapedrop_addresses') || '[]');
        let editIndex = -1;

        // User Greeting
        const user = JSON.parse(localStorage.getItem('drapedrop_currentUser') || '{}');
        if (user.firstName) {
            document.getElementById('sidebarUserName').textContent = user.firstName + (user.lastName ? ' ' + user.lastName : '');
        }

        function renderAddresses() {
            addressList.innerHTML = '';
            if (addresses.length === 0) {
                addressList.style.display = 'none';
                emptyState.style.display = 'block';
            } else {
                addressList.style.display = 'block';
                emptyState.style.display = 'none';

                addresses.forEach((addr, index) => {
                    const card = document.createElement('div');
                    card.className = 'address-card';
                    card.innerHTML = `
                        <div class="address-actions-menu" id="menu-${index}">
                            <button onclick="editAddress(${index})">Edit</button>
                            <button onclick="deleteAddress(${index})">Delete</button>
                        </div>
                        <i class="fas fa-ellipsis-v" style="position:absolute; right:20px; top:20px; cursor:pointer; color:#878787;" onclick="toggleMenu(${index})"></i>
                        
                        <div style="margin-bottom:10px;">
                            <span class="address-tag">${addr.type}</span>
                        </div>
                        <div style="display:flex; gap:15px; font-weight:600; margin-bottom:10px;">
                            <span>${addr.name}</span>
                            <span>${addr.mobile}</span>
                        </div>
                        <div style="color:#333; line-height:1.5; font-size:0.9rem;">
                            ${addr.addressArea}, ${addr.locality}, ${addr.city}, ${addr.state} - <strong>${addr.pincode}</strong>
                        </div>
                    `;
                    addressList.appendChild(card);
                });
            }
        }

        function toggleMenu(index) {
            const menu = document.getElementById(`menu-${index}`);
            const allMenus = document.querySelectorAll('.address-actions-menu');
            allMenus.forEach(m => {
                if (m !== menu) m.style.display = 'none';
            });
            menu.style.display = menu.style.display === 'flex' ? 'none' : 'flex';
        }

        // Show Form
        document.getElementById('addNewAddrBtn').addEventListener('click', () => {
            editIndex = -1;
            formHeader.textContent = 'ADD A NEW ADDRESS';
            document.getElementById('addrForm').reset();
            viewMode.style.display = 'none';
            formMode.style.display = 'block';
        });

        // Cancel Form
        document.getElementById('cancelAddrBtn').addEventListener('click', () => {
            viewMode.style.display = 'block';
            formMode.style.display = 'none';
        });

        // Save Logic
        document.getElementById('addrForm').addEventListener('submit', (e) => {
            e.preventDefault();

            const newAddr = {
                name: document.getElementById('name').value,
                mobile: document.getElementById('mobile').value,
                pincode: document.getElementById('pincode').value,
                locality: document.getElementById('locality').value,
                addressArea: document.getElementById('addressArea').value,
                city: document.getElementById('city').value,
                state: document.getElementById('state').value,
                landmark: document.getElementById('landmark').value,
                altPhone: document.getElementById('altPhone').value,
                type: document.querySelector('input[name="addrType"]:checked').value
            };

            if (editIndex === -1) {
                addresses.push(newAddr);
            } else {
                addresses[editIndex] = newAddr;
            }

            localStorage.setItem('drapedrop_addresses', JSON.stringify(addresses));
            renderAddresses();
            viewMode.style.display = 'block';
            formMode.style.display = 'none';
        });

        // Edit Function (Global scope needed for onclick)
        window.editAddress = function (index) {
            editIndex = index;
            const addr = addresses[index];

            document.getElementById('name').value = addr.name;
            document.getElementById('mobile').value = addr.mobile;
            document.getElementById('pincode').value = addr.pincode;
            document.getElementById('locality').value = addr.locality;
            document.getElementById('addressArea').value = addr.addressArea;
            document.getElementById('city').value = addr.city;
            document.getElementById('state').value = addr.state; // Ensure state value matches option
            document.getElementById('landmark').value = addr.landmark || '';
            document.getElementById('altPhone').value = addr.altPhone || '';

            const typeRadios = document.getElementsByName('addrType');
            typeRadios.forEach(r => {
                if (r.value === addr.type) r.checked = true;
            });

            formHeader.textContent = 'EDIT ADDRESS';
            viewMode.style.display = 'none';
            formMode.style.display = 'block';
        };

        window.deleteAddress = function (index) {
            if (confirm('Are you sure you want to delete this address?')) {
                addresses.splice(index, 1);
                localStorage.setItem('drapedrop_addresses', JSON.stringify(addresses));
                renderAddresses();
            }
        };

        window.toggleMenu = toggleMenu;

        // Geolocation Logic (Simplified reuse from checkout)
        document.getElementById('useLocationBtn').addEventListener('click', () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(success, error);
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        });

        function success(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
                .then(response => response.json())
                .then(data => {
                    const addr = data.address;
                    if (addr.postcode) document.getElementById('pincode').value = addr.postcode;
                    if (addr.city || addr.town || addr.village) document.getElementById('city').value = addr.city || addr.town || addr.village;
                    if (addr.state) document.getElementById('state').value = addr.state;
                    // Basic filling, might need more mapping depending on API response
                })
                .catch(() => alert('Could not fetch address.'));
        }

        function error() {
            alert("Unable to retrieve your location");
        }

        renderAddresses();
    </script>
</body>

</html>