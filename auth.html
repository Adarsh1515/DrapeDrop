<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login/Register - DrapeDrop</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.google.com/recaptcha/api.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-database-compat.js"></script>
    <script src="firebase-config.js"></script>
    <style>
        .auth-container {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .auth-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            width: 100%;
            max-width: 900px;
            display: flex;
            min-height: 600px;
        }

        .auth-sidebar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            width: 40%;
        }

        .auth-sidebar h2 {
            font-size: 2rem;
            margin-bottom: 20px;
            text-align: center;
        }

        .auth-sidebar p {
            text-align: center;
            line-height: 1.6;
            opacity: 0.9;
        }

        .auth-main {
            padding: 40px;
            width: 60%;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #f0f0f0;
        }

        .auth-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .auth-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .otp-actions {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .btn-inline {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            background-color: #f0f0f0;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.3s ease;
        }

        .btn-inline:hover {
            background-color: #e0e0e0;
        }

        .btn-inline.secondary {
            background-color: #e0e0e0;
            color: #333;
        }

        .btn-inline.secondary:hover {
            background-color: #d0d0d0;
        }

        .btn-inline.success {
            background-color: #28a745;
            color: white;
            border-color: #28a745;
        }

        .btn-inline.error {
            background-color: #dc3545;
            color: white;
            border-color: #dc3545;
        }

        .otp-actions input[type="text"] {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 0.9rem;
            text-align: center;
            letter-spacing: 2px;
        }

        .otp-actions input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        .otp-status {
            font-size: 0.85rem;
            font-weight: 500;
            min-width: 80px;
        }

        .otp-status.success {
            color: #28a745;
        }

        .otp-status.error {
            color: #dc3545;
        }

        .otp-status.pending {
            color: #ffc107;
        }

        .otp-for-seller {
            display: none;
        }

        .otp-for-seller.show {
            display: flex !important;
        }

        .verification-status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
        }

        .verification-status p {
            margin: 0;
            color: #6c757d;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .verification-status i {
            color: #667eea;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .submit-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .submit-btn:disabled:hover {
            transform: none;
            box-shadow: none;
        }

        .forgot-password {
            text-align: center;
            margin-top: 15px;
        }

        .forgot-password a {
            color: #667eea;
            text-decoration: none;
            font-size: 0.9rem;
        }

        .forgot-password a:hover {
            text-decoration: underline;
        }

        .error-message {
            background: #fee;
            color: #c33;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        .success-message {
            background: #efe;
            color: #3c3;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        .user-type-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .user-type-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid #e1e5e9;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .user-type-btn.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        @media (max-width: 768px) {
            .auth-card {
                flex-direction: column;
                max-width: 400px;
            }

            .auth-sidebar {
                width: 100%;
                padding: 30px 20px;
            }

            .auth-main {
                width: 100%;
                padding: 30px 20px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }

        .p-conf,
        .n-conf {
            width: calc(100% - 22px);
            border: 2px solid green;
            border-radius: 4px;
            padding: 8px 10px;
            margin: 4px 0px;
            background-color: rgba(0, 249, 12, 0.5);
            display: none;
        }

        .n-conf {
            border-color: red;
            background-color: rgba(255, 0, 4, 0.5);
        }

        .phone-input-container {
            display: flex;
            gap: 10px;
            align-items: stretch;
            /* Ensure equal height */
        }

        .phone-input-container input {
            flex: 1;
        }

        .phone-input-container button {
            white-space: nowrap;
            padding: 0 25px;
            /* Increased padding */
            background-color: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            /* Increased font size */
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .phone-input-container button:hover {
            background-color: #5a6fd6;
        }

        .otp-verify-section {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .otp-timer-container {
            margin-top: 10px;
            text-align: center;
            font-size: 0.9rem;
        }

        #otpTimerText {
            color: #666;
            font-weight: 500;
        }

        .resend-btn {
            background: none;
            border: none;
            color: #667eea;
            font-weight: 600;
            cursor: pointer;
            text-decoration: underline;
            padding: 0;
            font-size: 0.9rem;
        }

        .resend-btn:hover {
            color: #5a6fd6;
        }

        .auth-footer {
            margin-top: 20px;
            text-align: center;
            font-size: 0.95rem;
            color: #666;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }

        .auth-footer a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }

        .auth-footer a:hover {
            text-decoration: underline;
        }
    </style>
</head>

<body>
    <div class="auth-container">
        <div class="auth-card">
            <div class="auth-sidebar">
                <h2><i class="fas fa-tshirt"></i> DrapeDrop</h2>
                <p>Your trusted platform for buying and renting pre-loved dresses. Join our community of fashion
                    enthusiasts!</p>
            </div>

            <div class="auth-main">
                <!-- Login Form -->
                <div class="auth-form active" id="loginForm">
                    <div class="user-type-selector">
                        <button class="user-type-btn active" onclick="selectUserType('user')">User</button>
                        <button class="user-type-btn" onclick="selectUserType('admin')">Seller</button>
                    </div>

                    <div id="loginMessage"></div>

                    <form onsubmit="handleLogin(event)">
                        <div class="form-group">
                            <label for="loginPhone">Phone Number</label>
                            <input type="tel" id="loginPhone" placeholder="+91 98765 43210"
                                oninput="formatPhoneNumber(this)" required>
                        </div>

                        <div class="form-group">
                            <label for="loginPassword">Password</label>
                            <input type="password" id="loginPassword" required>
                        </div>

                        <button type="submit" class="submit-btn">
                            <i class="fas fa-sign-in-alt"></i>
                            Login
                        </button>
                    </form>

                    <div class="forgot-password">
                        <a href="#" onclick="showForgotPassword()">Forgot Password?</a>
                    </div>
                    <div class="auth-footer">
                        <p>Don't have an account? <a href="#" onclick="switchTab('register')">Register</a></p>
                    </div>
                </div>

                <!-- Forgot Password Section -->
                <div class="auth-form" id="forgotPasswordSection" style="display: none;">
                    <h3>Reset Password</h3>
                    <p style="color: #666; margin-bottom: 20px;">Enter your phone number to receive an OTP.</p>

                    <div id="forgotPasswordMessage"></div>

                    <form onsubmit="event.preventDefault();">
                        <div class="form-group">
                            <label for="forgotPhone">Phone Number</label>
                            <div class="phone-input-container">
                                <input type="tel" id="forgotPhone" placeholder="+91 98765 43210"
                                    oninput="formatPhoneNumber(this)" required>
                                <button type="button" id="sendForgotOtpBtn" class="btn-inline"
                                    onclick="sendForgotPasswordOtp()">Send OTP</button>
                            </div>
                        </div>

                        <div id="forgotOtpVerifySection" style="display: none;">
                            <div class="form-group">
                                <label>Enter OTP</label>
                                <div class="otp-actions">
                                    <input type="text" id="forgotOtpInput" placeholder="Enter OTP" maxlength="6">
                                    <button type="button" class="btn-inline secondary" id="verifyForgotOtpBtn"
                                        onclick="verifyForgotPasswordOtp()">Verify</button>
                                </div>
                            </div>
                        </div>

                        <div id="resetPasswordFields" style="display: none;">
                            <div class="form-group">
                                <label for="newPassword">New Password</label>
                                <input type="password" id="newPassword" required minlength="6">
                            </div>
                            <div class="form-group">
                                <label for="confirmNewPassword">Confirm New Password</label>
                                <input type="password" id="confirmNewPassword" required minlength="6">
                            </div>
                            <button type="button" class="submit-btn" onclick="resetPassword()">Reset Password</button>
                        </div>

                        <div class="auth-footer">
                            <p><a href="#" onclick="cancelForgotPassword()">Back to Login</a></p>
                        </div>
                    </form>
                </div>

                <!-- Register Form -->
                <div class="auth-form" id="registerForm">
                    <div class="user-type-selector">
                        <button class="user-type-btn active" onclick="selectUserType('user')">User</button>
                        <button class="user-type-btn" onclick="selectUserType('admin')">Seller</button>
                    </div>

                    <div id="registerMessage"></div>

                    <form onsubmit="handleRegister(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="registerFirstName">First Name</label>
                                <input type="text" id="registerFirstName" required>
                            </div>
                            <div class="form-group">
                                <label for="registerLastName">Last Name</label>
                                <input type="text" id="registerLastName" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <div class="otp-actions" id="emailOtpRow" style="display: none;">
                                <!-- Invisible Recaptcha attached to button -->
                            </div>
                            <label for="registerEmail">Email Address</label>
                            <input type="email" id="registerEmail" required>

                        </div>

                        <div class="form-group">
                            <label for="registerPhone">Phone Number</label>
                            <div class="phone-input-container">
                                <input type="tel" id="registerPhone" placeholder="+91 98765 43210"
                                    oninput="formatPhoneNumber(this)" required>
                                <button type="button" id="sendOtpBtn" class="btn-inline" onclick="phoneAuth()">Send
                                    OTP</button>
                            </div>
                            <small style="color: #666; font-size: 0.9rem;">Enter with country code (e.g., +91 for
                                India)</small>

                            <div class="otp-verify-section" id="otpVerifySection" style="display: none;">
                                <div class="otp-actions">
                                    <input type="text" id="phoneOtpInput" placeholder="Enter OTP" maxlength="6">
                                    <button type="button" class="btn-inline secondary" id="verifyOtpBtn"
                                        onclick="codeverify()">Verify</button>
                                    <span class="otp-status" id="phoneOtpStatus"></span>
                                </div>
                                <div class="otp-timer-container">
                                    <span id="otpTimerText">Resend OTP in 15s</span>
                                    <button type="button" id="resendOtpBtn" class="resend-btn" onclick="resendOtp()"
                                        style="display: none;">Resend OTP</button>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="registerPassword">Password</label>
                            <input type="password" id="registerPassword" required minlength="6">
                        </div>

                        <div class="form-group">
                            <label for="registerConfirmPassword">Confirm Password</label>
                            <input type="password" id="registerConfirmPassword" required minlength="6">
                        </div>

                        <button type="submit" class="submit-btn">
                            <i class="fas fa-user-plus"></i>
                            Register
                        </button>
                        <div id="verificationStatus" class="verification-status" style="display: none;">
                            <p><i class="fas fa-info-circle"></i> <span id="verificationText"></span></p>
                        </div>
                        <div class="auth-footer">
                            <p>Already have an account? <a href="#" onclick="switchTab('login')">Login</a></p>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentUserType = 'user';
        let currentTab = 'login';

        // Initialize Firebase Database
        const db = firebase.database();


        function switchTab(tab) {
            currentTab = tab;

            // Show/hide forms
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            document.getElementById(tab + 'Form').classList.add('active');

            // Clear messages
            document.getElementById('loginMessage').innerHTML = '';
            document.getElementById('registerMessage').innerHTML = '';

            // If switching to register tab, check button state
            if (tab === 'register') {
                setTimeout(() => checkRegisterButtonState(), 100);
            }
        }

        function selectUserType(type) {
            currentUserType = type;

            // Update button styling
            document.querySelectorAll('.user-type-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Clear OTP verification status when switching user types
            sessionStorage.removeItem('otp_phone_verified');
            const phoneOtpInput = document.getElementById('phoneOtpInput');
            const phoneOtpStatus = document.getElementById('phoneOtpStatus');
            if (phoneOtpInput) phoneOtpInput.value = '';
            if (phoneOtpStatus) phoneOtpStatus.textContent = '';

            // Reset verify button
            const verifyBtn = document.getElementById('verifyOtpBtn');
            if (verifyBtn) {
                verifyBtn.textContent = 'Verify';
                verifyBtn.classList.remove('success', 'error');
                verifyBtn.classList.add('secondary');
                verifyBtn.disabled = false;
            }

            // Clear timer
            if (otpTimerInterval) clearInterval(otpTimerInterval);

            // Ensure OTP verify section is hidden initially
            const otpVerifySection = document.getElementById('otpVerifySection');
            if (otpVerifySection) otpVerifySection.style.display = 'none';

            // Reset Send OTP button
            const sendOtpBtn = document.getElementById('sendOtpBtn');
            if (sendOtpBtn) {
                sendOtpBtn.style.display = 'block';
                sendOtpBtn.disabled = false;
                sendOtpBtn.style.opacity = '1';
                sendOtpBtn.style.cursor = 'pointer';
            }

            // Check and update register button state
            checkRegisterButtonState();
        }

        function showMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="${type}-message">${message}</div>`;
        }

        // OTP simulation logic
        //Recaptcha field
        render();
        function render() {
            window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('sendOtpBtn', {
                'size': 'invisible',
                'callback': (response) => {
                    // reCAPTCHA solved, allow signInWithPhoneNumber.
                    // onSignInSubmit();
                }
            });
            recaptchaVerifier.render();
        }


        let otpTimerInterval;

        // function to send OTP
        function phoneAuth() {
            var number = document.getElementById('registerPhone').value;

            // Validation
            const cleanNumber = number.replace(/\D/g, '');
            if (!number || !number.startsWith('+') || cleanNumber.length !== 12) {
                showMessage('registerMessage', "Invalid Phone number. Please enter valid phone number.", 'error');
                return;
            }

            firebase.auth().signInWithPhoneNumber(number, window.recaptchaVerifier).then(function (confirmationResult) {
                window.confirmationResult = confirmationResult;
                coderesult = confirmationResult;

                // Show OTP verification section
                document.getElementById('otpVerifySection').style.display = 'block';
                showMessage('registerMessage', 'OTP sent successfully!', 'success');

                // Start Timer
                startOtpTimer();
            }).catch(function (error) {
                // Re-enable Send OTP button on error
                const sendOtpBtn = document.getElementById('sendOtpBtn');
                if (sendOtpBtn) {
                    sendOtpBtn.disabled = false;
                    sendOtpBtn.style.opacity = '1';
                    sendOtpBtn.style.cursor = 'pointer';
                }

                if (error.code === 'auth/too-many-requests') {
                    showMessage('registerMessage', "You've reached maximum attempts to generate OTP. Try again later.", 'error');
                } else if (error.code === 'auth/internal-error') {
                    showMessage('registerMessage', "Check your internet connection. Try again.", 'error');
                } else {
                    alert(error.message);
                }
            });
        }

        function startOtpTimer() {
            let timeLeft = 60;
            const timerText = document.getElementById('otpTimerText');
            const resendBtn = document.getElementById('resendOtpBtn');
            const sendOtpBtn = document.getElementById('sendOtpBtn');

            // Reset UI
            timerText.style.display = 'inline';
            resendBtn.style.display = 'none';
            timerText.textContent = `Resend OTP in ${timeLeft}s`;

            // Disable Send OTP button
            if (sendOtpBtn) {
                sendOtpBtn.disabled = true;
                sendOtpBtn.style.opacity = '0.6';
                sendOtpBtn.style.cursor = 'not-allowed';
            }

            // Clear existing timer if any
            if (otpTimerInterval) clearInterval(otpTimerInterval);

            otpTimerInterval = setInterval(() => {
                timeLeft--;
                timerText.textContent = `Resend OTP in ${timeLeft}s`;

                if (timeLeft <= 0) {
                    clearInterval(otpTimerInterval);
                    timerText.style.display = 'none';
                    resendBtn.style.display = 'inline';

                    // Enable Send OTP button
                    if (sendOtpBtn) {
                        sendOtpBtn.disabled = false;
                        sendOtpBtn.style.opacity = '1';
                        sendOtpBtn.style.cursor = 'pointer';
                    }

                    // Hide success message when timer expires
                    document.getElementById('registerMessage').innerHTML = '';
                }
            }, 1000);
        }

        function resendOtp() {
            phoneAuth();
        }
        // function to verify the OTP
        function codeverify() {
            var code = document.getElementById('phoneOtpInput').value;
            var verifyBtn = document.getElementById('verifyOtpBtn');

            coderesult.confirm(code).then(function () {
                // Success state
                verifyBtn.textContent = 'Verified';
                verifyBtn.classList.remove('secondary', 'error');
                verifyBtn.classList.add('success');
                verifyBtn.disabled = true; // Prevent re-verification

                // Set verified flag and update button state
                sessionStorage.setItem('otp_phone_verified', 'true');
                checkRegisterButtonState();

                // Stop the timer
                if (otpTimerInterval) clearInterval(otpTimerInterval);
                document.getElementById('otpTimerText').style.display = 'none';
            }).catch(function () {
                // Error state
                verifyBtn.textContent = 'Invalid';
                verifyBtn.classList.remove('secondary', 'success');
                verifyBtn.classList.add('error');

                // Reset to "Verify" after a delay to allow retry
                setTimeout(() => {
                    verifyBtn.textContent = 'Verify';
                    verifyBtn.classList.remove('error');
                    verifyBtn.classList.add('secondary');
                }, 2000);
            });
        }
        // const otpStore = { email: null, phone: null };

        // function sendOtp(kind) {
        //     let targetValue;
        //     if (kind === 'email') {
        //         targetValue = document.getElementById('registerEmail').value;
        //     } else {
        //         targetValue = document.getElementById('registerPhone').value;
        //     }

        //     if (!targetValue) { 
        //         alert('Please enter ' + (kind === 'email' ? 'email' : 'phone') + ' first.'); 
        //         return; 
        //     }

        //     const code = Math.floor(100000 + Math.random() * 900000).toString();
        //     otpStore[kind] = code;

        //     // Update status
        //     const statusElement = document.getElementById(kind + 'OtpStatus');
        //     statusElement.textContent = 'OTP Sent!';
        //     statusElement.className = 'otp-status pending';

        //     // Simulate sending by showing an alert
        //     alert(`Your ${kind.toUpperCase()} OTP is: ${code}`);
        // }

        // function verifyOtp(kind) {
        //     const inputElement = document.getElementById(kind + 'OtpInput');
        //     const statusElement = document.getElementById(kind + 'OtpStatus');
        //     const enteredOtp = inputElement.value;

        //     if (!enteredOtp) {
        //         statusElement.textContent = 'Enter OTP!';
        //         statusElement.className = 'otp-status error';
        //         return;
        //     }

        //     if (otpStore[kind] && enteredOtp === otpStore[kind]) {
        //         statusElement.textContent = 'Verified!';
        //         statusElement.className = 'otp-status success';
        //         sessionStorage.setItem('otp_' + kind + '_verified', 'true');
        //         inputElement.disabled = true;

        //         // Check if both OTPs are verified and update register button
        //         checkRegisterButtonState();
        //     } else {
        //         statusElement.textContent = 'Invalid OTP!';
        //         statusElement.className = 'otp-status error';
        //     }
        // }

        // Function to check and update register button state
        // Function to check and update register button state
        function checkRegisterButtonState() {
            const registerButton = document.querySelector('#registerForm .submit-btn');
            const verificationStatus = document.getElementById('verificationStatus');
            const verificationText = document.getElementById('verificationText');

            if (!registerButton) return;

            const phoneVerified = sessionStorage.getItem('otp_phone_verified') === 'true';

            if (phoneVerified) {
                // Verified - enable button
                registerButton.disabled = false;
                registerButton.style.opacity = '1';
                registerButton.style.cursor = 'pointer';
                registerButton.title = 'Click to register';

                // Hide verification status
                verificationStatus.style.display = 'none';
            } else {
                // Not verified - disable button
                registerButton.disabled = true;
                registerButton.style.opacity = '0.5';
                registerButton.style.cursor = 'not-allowed';

                const message = `Please verify your phone number via OTP before registering.`;
                registerButton.title = message;

                // Show verification status
                verificationText.textContent = message;
                verificationStatus.style.display = 'block';
            }
        }

        function handleLogin(event) {
            event.preventDefault();

            let phoneInput = document.getElementById('loginPhone').value;
            const password = document.getElementById('loginPassword').value;

            // Format phone number - add +91 if no country code provided
            if (phoneInput && !phoneInput.startsWith('+')) {
                phoneInput = '+91' + phoneInput;
            }

            const collection = currentUserType === 'user' ? 'users' : 'admins';

            // Helper to try login with a specific phone string
            const attemptLogin = (phoneToTry) => {
                return db.ref(collection).orderByChild('phone').equalTo(phoneToTry).once('value')
                    .then(snapshot => {
                        let user = null;
                        if (snapshot.exists()) {
                            snapshot.forEach(childSnapshot => {
                                const u = childSnapshot.val();
                                if (u.password === password) {
                                    user = u;
                                }
                            });
                        }
                        return user;
                    });
            };

            // STRATEGY: 
            // 1. Try exact input
            // 2. Try stripped spaces (standard)
            // 3. Try with standard spacing "+91 XXXXX XXXXX" (legacy)

            const cleanPhone = phoneInput.replace(/\s+/g, ''); // "9999999999" or "+919999999999"

            // Construct legacy format "+91 XXXXX XXXXX" if possible
            let legacyPhone = cleanPhone;
            if (cleanPhone.startsWith('+91') && cleanPhone.length === 13) {
                // +91 98765 43210
                const p = cleanPhone;
                legacyPhone = p.substring(0, 3) + ' ' + p.substring(3, 8) + ' ' + p.substring(8, 13);
            }

            showMessage('loginMessage', 'Verifying credentials...', 'info');

            attemptLogin(phoneInput)
                .then(user => {
                    if (user) return user;
                    // If failed, try cleaned version
                    if (phoneInput !== cleanPhone) {
                        console.log("Trying cleaned phone:", cleanPhone);
                        return attemptLogin(cleanPhone);
                    }
                    return null;
                })
                .then(user => {
                    if (user) return user;
                    // If failed, try legacy format
                    if (legacyPhone !== phoneInput && legacyPhone !== cleanPhone) {
                        console.log("Trying legacy phone format:", legacyPhone);
                        return attemptLogin(legacyPhone);
                    }
                    return null;
                })
                .then(user => {
                    if (user) {
                        // Store current user in session
                        const sessionData = {
                            id: user.id,
                            firstName: user.firstName,
                            lastName: user.lastName,
                            email: user.email,
                            type: user.type,
                            loginTime: new Date().toISOString()
                        };

                        localStorage.setItem('drapedrop_currentUser', JSON.stringify(sessionData));

                        showMessage('loginMessage', 'Login successful! Redirecting...', 'success');

                        setTimeout(() => {
                            window.location.href = 'index.html';
                        }, 1000);
                    } else {
                        showMessage('loginMessage', 'Invalid phone number or password. Please check and try again.', 'error');
                    }
                })
                .catch(error => {
                    console.error("Login Result:", error);
                    showMessage('loginMessage', 'Error logging in. Please try again.', 'error');
                });
        }

        function handleRegister(event) {
            event.preventDefault();

            const firstName = document.getElementById('registerFirstName').value;
            const lastName = document.getElementById('registerLastName').value;
            const email = document.getElementById('registerEmail').value;
            let phone = document.getElementById('registerPhone').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;

            // Format phone number - add +91 if no country code provided
            if (phone && !phone.startsWith('+')) {
                phone = '+91' + phone;
            }

            // Validation
            if (password !== confirmPassword) {
                showMessage('registerMessage', 'Passwords do not match!', 'error');
                return;
            }

            if (password.length < 6) {
                showMessage('registerMessage', 'Password must be at least 6 characters long!', 'error');
                return;
            }

            // Clean phone number for consistency
            // Remove spaces for logic, keep +
            // Actually, for check existing we should use exact match if we want to catch duplicates strictly?
            // No, we should strip spaces for check too to be safe.
            // But query needs to match DB. If DB has spaces...
            // Standardizing to NO SPACES for NEW users.

            // For checking duplicates, we might miss old users with spaces if we only check no-spaces.
            // But that's a smaller edge case than the login issue. Use the input phone as-is for now?
            // NO, let's just stick to the plan: Save new ones WITHOUT spaces.

            if (!phone || phone.length < 12) { // Logic check roughly
                showMessage('registerMessage', 'Please enter a valid phone number with country code!', 'error');
                return;
            }

            // Ensure phone number starts with +
            if (!phone.startsWith('+')) {
                showMessage('registerMessage', 'Phone number must start with country code (e.g., +91)!', 'error');
                return;
            }

            // Determine collection based on user type
            const collection = currentUserType === 'user' ? 'users' : 'admins';

            // Check if phone number or email already exists in the CURRENT collection only
            Promise.all([
                db.ref(collection).orderByChild('phone').equalTo(phone).once('value'),
                db.ref(collection).orderByChild('email').equalTo(email).once('value')
            ]).then(results => {
                const phoneSnap = results[0];
                const emailSnap = results[1];

                if (phoneSnap.exists()) {
                    showMessage('registerMessage', 'Phone number already registered as ' + currentUserType + '! Please use a different number.', 'error');
                    return;
                }

                if (emailSnap.exists()) {
                    showMessage('registerMessage', 'Email already registered as ' + currentUserType + '! Please use a different email.', 'error');
                    return;
                }

                // Create new user/admin object
                // Create new user/admin object
                const newUser = {
                    id: Date.now(),
                    firstName,
                    lastName,
                    email,
                    phone: phone.replace(/\s+/g, ''), // ALWAYS SAVE WITHOUT SPACES
                    password,
                    type: currentUserType,
                    createdAt: new Date().toISOString()
                };

                // For sellers, check if phone OTP is verified
                if (currentUserType === 'admin') {
                    const phoneVerified = sessionStorage.getItem('otp_phone_verified') === 'true';

                    if (!phoneVerified) {
                        showMessage('registerMessage', `Please verify your phone number via OTP before registering.`, 'error');
                        return;
                    }
                }

                const collection = currentUserType === 'user' ? 'users' : 'admins';

                // Save to Firebase
                // Use push() to generate a key, but we also put the ID inside.
                // Or set by ID. Let's use push for standard list behavior but maybe unnecessary complexity.
                // Let's us `set` on `collection + '/' + newUser.id` to have a predictable ID?
                // `Date.now()` is the ID.
                db.ref(collection + '/' + newUser.id).set(newUser)
                    .then(() => {
                        // Success
                        if (currentUserType === 'user') {
                            // Auto-login for user
                            const sessionData = {
                                id: newUser.id,
                                firstName: newUser.firstName,
                                lastName: newUser.lastName,
                                email: newUser.email,
                                type: newUser.type,
                                loginTime: new Date().toISOString()
                            };
                            localStorage.setItem('drapedrop_currentUser', JSON.stringify(sessionData));

                            showMessage('registerMessage', 'Registration successful! Redirecting...', 'success');
                            event.target.reset();

                            // Clear OTP verification status
                            sessionStorage.removeItem('otp_phone_verified');

                            // Reset OTP fields
                            resetOtpFields();

                            setTimeout(() => { window.location.href = 'index.html'; }, 1000);
                        } else {
                            // Auto-login for seller
                            const sessionData = {
                                id: newUser.id,
                                firstName: newUser.firstName,
                                lastName: newUser.lastName,
                                email: newUser.email,
                                type: newUser.type,
                                loginTime: new Date().toISOString()
                            };
                            localStorage.setItem('drapedrop_currentUser', JSON.stringify(sessionData));

                            showMessage('registerMessage', 'Registration successful! Redirecting to dashboard...', 'success');
                            event.target.reset();

                            // Clear OTP verification status
                            sessionStorage.removeItem('otp_phone_verified');

                            // Reset OTP fields
                            resetOtpFields();

                            setTimeout(() => { window.location.href = 'index.html'; }, 1000);
                        }
                    })
                    .catch(error => {
                        showMessage('registerMessage', 'Error saving user data: ' + error.message, 'error');
                    });

            }).catch(error => {
                showMessage('registerMessage', 'Error validating registration: ' + error.message, 'error');
            });
        }

        // Function to reset OTP fields and status
        function resetOtpFields() {
            const emailOtpInput = document.getElementById('emailOtpInput');
            const phoneOtpInput = document.getElementById('phoneOtpInput');
            const emailOtpStatus = document.getElementById('emailOtpStatus');
            const phoneOtpStatus = document.getElementById('phoneOtpStatus');

            if (emailOtpInput) {
                emailOtpInput.value = '';
                emailOtpInput.disabled = false;
            }
            if (phoneOtpInput) {
                phoneOtpInput.value = '';
                phoneOtpInput.disabled = false;
            }
            if (emailOtpStatus) emailOtpStatus.textContent = '';
            if (phoneOtpStatus) phoneOtpStatus.textContent = '';
        }

        // Format phone number as user types
        function formatPhoneNumber(input) {
            // Keep UI formatting for better UX, but we will strip it for logic
            let value = input.value.replace(/\D/g, '');

            if (value.length > 0 && !input.value.startsWith('+')) {
                if (value.length <= 10) {
                    input.value = '+91 ' + value;
                } else if (value.length > 10) {
                    // Try to preserve Country Code if user pasted it
                    // Simple heuristic: if > 10, assume first digits are CC or part of it
                    // ideally we just enforce standard +91 for this specific app context
                    // But let's stick to the previous simple logic for UI visual consistency
                    input.value = '+91 ' + value.substring(0, 10);
                }
            }
        }

        function showForgotPassword() {
            const email = prompt('Enter your email address to reset password:');
            if (email) {
                alert('Password reset link has been sent to your email address. Please check your inbox.');
            }
        }

        // Check if user is already logged in
        window.onload = function () {
            // Check for registration success message
            const urlParams = new URLSearchParams(window.location.search);
            const message = urlParams.get('message');

            if (message === 'registration_success') {
                showMessage('loginMessage', 'Phone verification completed! You can now login with your credentials.', 'success');
                // Clear the message from URL
                window.history.replaceState({}, document.title, window.location.pathname);
            }

            const currentUser = localStorage.getItem('drapedrop_currentUser');
            if (currentUser) {
                // User is already logged in, redirect to dashboard
                window.location.href = 'index.html';
            }

            // Initialize register button state
            checkRegisterButtonState();
        };
        // Check for tab parameter in URL
        window.addEventListener('DOMContentLoaded', (event) => {
            const urlParams = new URLSearchParams(window.location.search);
            const tab = urlParams.get('tab');
            if (tab === 'register') {
                switchTab('register');
            }
        });
        // Forgot Password Logic
        let forgotPasswordConfirmationResult = null;

        function showForgotPassword() {
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            document.getElementById('forgotPasswordSection').style.display = 'block';
            document.getElementById('forgotPasswordSection').classList.add('active');
            document.getElementById('loginMessage').innerHTML = '';
        }

        function cancelForgotPassword() {
            document.getElementById('forgotPasswordSection').style.display = 'none';
            document.getElementById('forgotPasswordSection').classList.remove('active');
            switchTab('login');
        }

        function sendForgotPasswordOtp() {
            let phone = document.getElementById('forgotPhone').value;
            if (!phone || phone.length < 10) {
                showMessage('forgotPasswordMessage', 'Please enter a valid phone number.', 'error');
                return;
            }

            if (!phone.startsWith('+')) {
                phone = '+91' + phone;
            }

            // Check if user exists before sending OTP
            const sendBtn = document.getElementById('sendForgotOtpBtn');
            sendBtn.disabled = true;
            sendBtn.textContent = 'Checking...';

            Promise.all([
                db.ref('users').orderByChild('phone').equalTo(phone).once('value'),
                db.ref('admins').orderByChild('phone').equalTo(phone).once('value')
            ]).then(results => {
                const userSnap = results[0];
                const adminSnap = results[1];

                if (!userSnap.exists() && !adminSnap.exists()) {
                    showMessage('forgotPasswordMessage', 'No account found with this phone number.', 'error');
                    sendBtn.disabled = false;
                    sendBtn.textContent = 'Send OTP';
                    return;
                }

                sendBtn.textContent = 'Sending...';

                firebase.auth().signInWithPhoneNumber(phone, window.recaptchaVerifier)
                    .then(function (confirmationResult) {
                        forgotPasswordConfirmationResult = confirmationResult;
                        showMessage('forgotPasswordMessage', 'OTP sent successfully!', 'success');
                        document.getElementById('forgotOtpVerifySection').style.display = 'block';
                        sendBtn.textContent = 'Sent';
                    }).catch(function (error) {
                        sendBtn.disabled = false;
                        sendBtn.textContent = 'Send OTP';
                        showMessage('forgotPasswordMessage', error.message, 'error');
                    });
            }).catch(error => {
                sendBtn.disabled = false;
                sendBtn.textContent = 'Send OTP';
                showMessage('forgotPasswordMessage', 'Error checking user: ' + error.message, 'error');
            });
        }

        function verifyForgotPasswordOtp() {
            const code = document.getElementById('forgotOtpInput').value;
            const verifyBtn = document.getElementById('verifyForgotOtpBtn');

            if (!code) return;

            verifyBtn.textContent = 'Verifying...';

            if (forgotPasswordConfirmationResult) {
                forgotPasswordConfirmationResult.confirm(code).then(function (result) {
                    verifyBtn.textContent = 'Verified';
                    verifyBtn.classList.remove('secondary');
                    verifyBtn.classList.add('success');
                    verifyBtn.disabled = true;

                    document.getElementById('resetPasswordFields').style.display = 'block';
                    showMessage('forgotPasswordMessage', 'Phone verified! Enter new password.', 'success');
                }).catch(function (error) {
                    verifyBtn.textContent = 'Invalid';
                    verifyBtn.classList.add('error');
                    setTimeout(() => {
                        verifyBtn.textContent = 'Verify';
                        verifyBtn.classList.remove('error');
                    }, 2000);
                });
            }
        }

        function resetPassword() {
            const newPass = document.getElementById('newPassword').value;
            const confirmPass = document.getElementById('confirmNewPassword').value;
            let phone = document.getElementById('forgotPhone').value;

            if (newPass !== confirmPass) {
                showMessage('forgotPasswordMessage', 'Passwords do not match.', 'error');
                return;
            }

            if (newPass.length < 6) {
                showMessage('forgotPasswordMessage', 'Password must be at least 6 characters.', 'error');
                return;
            }

            if (!phone.startsWith('+')) {
                phone = '+91' + phone;
            }

            // Update password in Firebase
            Promise.all([
                db.ref('users').orderByChild('phone').equalTo(phone).once('value'),
                db.ref('admins').orderByChild('phone').equalTo(phone).once('value')
            ]).then(results => {
                const userSnap = results[0];
                const adminSnap = results[1];
                let updatePromise = null;

                if (userSnap.exists()) {
                    userSnap.forEach(child => {
                        updatePromise = db.ref('users/' + child.key).update({ password: newPass });
                    });
                } else if (adminSnap.exists()) {
                    adminSnap.forEach(child => {
                        updatePromise = db.ref('admins/' + child.key).update({ password: newPass });
                    });
                } else {
                    showMessage('forgotPasswordMessage', 'User not found.', 'error');
                    return;
                }

                if (updatePromise) {
                    updatePromise.then(() => {
                        showMessage('forgotPasswordMessage', 'Password reset successful! Redirecting to login...', 'success');
                        setTimeout(() => {
                            cancelForgotPassword();
                        }, 2000);
                    }).catch(error => {
                        showMessage('forgotPasswordMessage', 'Error updating password: ' + error.message, 'error');
                    });
                }

            }).catch(error => {
                showMessage('forgotPasswordMessage', 'Error resetting password: ' + error.message, 'error');
            });
        }
    </script>
</body>

</html>